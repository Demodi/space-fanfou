<!DOCTYPE HTML>

<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript">
	// 显示太空饭否 Logo
	chrome.tabs.onUpdated.addListener(
		function(tabId, changeInfo, tab) {
			if (tab.url.substr(0, 18) == 'http://fanfou.com/')
				chrome.pageAction.show(tabId);
		}
	);

	var caches = {};

	/* 分享到饭否 */

	var menu_share = 0;
	function changeShareOption(value) {
		if (value) {
			menu_share = chrome.contextMenus.create({
				title: '分享到饭否',
				contexts: ['page', 'selection'],
				onclick: function(info, tab) {
					var params = $.param({
						u: tab.url, t: tab.title,
						d: info.selectionText ? info.selectionText : '', s: 'bm'
					});
					window.open('http://fanfou.com/sharer?' + params, 'sharer', 
								'toolbar=0,status=0,resizable=0,width=600,height=400');
				}
			});
		} else {
			if (! menu_share) return;
			chrome.contextMenus.remove(menu_share);
			menu_share = 0;
		}
	}

	/* 插件信息 */

	// 默认值
	var default_values = {
		// 扩展功能
		'expanding_replies': true,
		'expanding_replies.number': 3,
		'image_uploading': true,
		'user_switcher': false,
		'float_message': false,
		'share_to_fanfou': true,
		'repost_photo_preview': true,
		// 页面样式
		'font_reset': false,
        'translucent_sidebar': true,
        'newstyle_trendlist': true,
        'logo_remove_beta': false
	};
	
	// 修改钩子
	var value_hooks = {
		'share_to_fanfou': changeShareOption,
	};

	// 读取插件信息
	function readRawData(key) {
		if (localStorage[key] !== undefined)
			return JSON.parse(localStorage[key]);
		else
			return default_values[key];
	}
	function readData(key) {
		if (typeof key == 'string') {
			return readRawData(key);
		} else {
			var ret = [];
			for (var i = 0; i < key.length; ++i)
				ret.push(readRawData(key[i]));
			return ret;
		}
	}

	// 写入插件信息
	function saveRawData(key, value) {
		caches = {};
		localStorage[key] = JSON.stringify(value);
		if (value_hooks[key])
			value_hooks[key](value);
	}
	function saveData(data) {
		for (var key in data) {
			if (! data.hasOwnProperty(key)) continue;
			saveRawData(key, data[key]);
		}
	}

	// 与脚本交互
	chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
			if (typeof window[request.func] == 'function')
				sendResponse(window[request.func](request.data));
		}
	);

	// 初始化选项钩子
	for (var key in value_hooks) {
		if (! value_hooks.hasOwnProperty(key)) continue;
		value_hooks[key](readRawData(key));
	}
	
	/* 样式 */

	var css_switches = [
		['font_reset', 'font-reset-all.css', 'font-reset-en.css'],
        ['translucent_sidebar', 'translucent-sidebar.css', null],
        ['newstyle_trendlist', 'newstyle-trendlist.css', null],
        ['logo_remove_beta', 'logo-remove-beta.css', null]
	];

	// 样式缓存
	var css_cache = { };
	function cacheCSS(file) {
        $.get('css/' + file, function(data) {
            css_cache[file] = data;
        });
	}

	// 缓存所有样式
	for (var i = 0; i < css_switches.length; ++i) {
		var item = css_switches[i];
		if (item[1]) cacheCSS(item[1]);
		if (item[2]) cacheCSS(item[2]);
	}

	// 读取样式
	function getStyles() {
		if (caches.styles)
			return caches.styles;
		var styles = '';
		for (var i = 0; i < css_switches.length; ++i) {
			var item = css_switches[i];
			if (readRawData(item[0])) {
				if (item[1] in css_cache)
					styles += css_cache[item[1]];
			} else {
				if (item[2] in css_cache)
					styles += css_cache[item[2]];
			}
		}
		caches.styles = styles;
		return styles;
	}
	getStyles();
</script>
</head>
<body>
</body>
</html>
