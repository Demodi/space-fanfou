<!DOCTYPE HTML>

<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript">
	// 显示太空饭否 Logo
	chrome.tabs.onUpdated.addListener(
		function(tabId, changeInfo, tab) {
			if (tab.url.substr(0, 18) == 'http://fanfou.com/')
				chrome.pageAction.show(tabId);
		}
	);

	var caches = {};

	/* 插件信息 */

	// 默认值
	var default_values = {
		'expanding_replies': true,
		'expanding_replies.number': 3,
		'image_uploading': true,
		'user_switcher': false,
		'font_reset': false,
		'translucent_sidebar': true,
	};

	// 读取插件信息
	function readRawData(key) {
		if (localStorage[key] !== undefined)
			return JSON.parse(localStorage[key]);
		else
			return default_values[key];
	}
	function readData(key) {
		if (typeof key == 'string') {
			return readRawData(key);
		} else {
			var ret = [];
			for (var i = 0; i < key.length; ++i)
				ret.push(readRawData(key[i]));
			return ret;
		}
	}

	// 写入插件信息
	function saveRawData(key, value) {
		caches = {};
		localStorage[key] = JSON.stringify(value);
	}
	function saveData(data) {
		for (var key in data) {
			if (! data.hasOwnProperty(key)) continue;
			saveRawData(key, data[key]);
		}
	}

	// 与脚本交互
	chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
			if (typeof window[request.func] == 'function')
				sendResponse(window[request.func](request.data));
		}
	);
	
	/* 样式 */

	var css_switches = [
		['font_reset', 'font-reset-all.css', 'font-reset-en.css'],
		['translucent_sidebar', 'translucent-sidebar.css', null]
	];

	// 样式缓存
	var css_cache = { };
	function cacheCSS(file) {
        $.get('css/' + file, function(data) {
            css_cache[file] = data;
        });
	}

	// 缓存所有样式
	for (var i = 0; i < css_switches.length; ++i) {
		var item = css_switches[i];
		if (item[1]) cacheCSS(item[1]);
		if (item[2]) cacheCSS(item[2]);
	}

	// 读取样式
	function getStyles() {
		if (caches.styles)
			return caches.styles;
		var styles = '';
		for (var i = 0; i < css_switches.length; ++i) {
			var item = css_switches[i];
			if (readRawData(item[0])) {
				if (item[1] in css_cache)
					styles += css_cache[item[1]];
			} else {
				if (item[2] in css_cache)
					styles += css_cache[item[2]];
			}
		}
		caches.styles = styles;
		return styles;
	}
	getStyles();
</script>
</head>
<body>
</body>
</html>
