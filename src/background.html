<!DOCTYPE HTML>

<html lang="zh-CN">

<head>
<meta charset="UTF-8">
<script type="text/javascript">
	// 显示太空饭否 Logo
	chrome.tabs.onUpdated.addListener(
		function(tabId, changeInfo, tab) {
			if (tab.url.substr(0, 18) == 'http://fanfou.com/')
				chrome.pageAction.show(tabId);
		}
	);

	/* 插件信息 */

	// 默认值
	var default_values = {
		'expanding_replies': true,
		'expanding_replies.number': 3,
		'image_uploading': true,
		'font_reset': true,
		'translucent_sidebar': true,
	};

	// 读取插件信息
	function readData(key) {
		var readRawData = function(key) {
			if (localStorage[key] !== undefined)
				return JSON.parse(localStorage[key]);
			else
				return default_values[key];
		};
		if (typeof key == 'string') {
			return readRawData(key);
		} else {
			var ret = [];
			for (var i = 0; i < key.length; ++i)
				ret.push(readRawData(key[i]));
			return ret;
		}
	}

	// 写入插件信息
	function saveData(data) {
		var saveRawData = function(key, value) {
			localStorage[key] = JSON.stringify(value);
		};
		for (var key in data) {
			if (! data.hasOwnProperty(key)) continue;
			saveRawData(key, data[key]);
		}
	}

	// 与脚本交互
	chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
			if (typeof window[request.func] == 'function')
				sendResponse(window[request.func](request.data));
		}
	);

	/* 样式 */

	var css_switches = [
		['font_reset', 'font-reset-all.css', 'font-reset-en.css'],
		['translucent_sidebar', 'translucent-sidebar.css', null]
	];

	chrome.tabs.onUpdated.addListener(
		function(tabId, changeInfo, tab) {
			if (tab.url.substr(0, 18) != 'http://fanfou.com/')
				return;
			for (var i = 0; i < css_switches.length; ++i) {
				var css_file = readData(css_switches[i][0]) ?
					css_switches[i][1] : css_switches[i][2];
				if (! css_file) continue;
				chrome.tabs.insertCSS(tabId, { file: 'styles/' + css_file });
			}
		}
	);
	
</script>
</head>

</html>
